<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- å¤´éƒ¨æ¬¢è¿åŒºåŸŸ -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <div class="container mx-auto px-4 py-12">
        <div class="text-center">
          <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">
            æ¬¢è¿ä½¿ç”¨ <span class="text-blue-600">ArchiveNote</span>
          </h1>
          <p class="text-xl text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
            æ‚¨çš„ä¸ªäººæ–‡ä»¶å’Œç¬”è®°ç®¡ç†ä¸­å¿ƒï¼Œè®©ä¿¡æ¯æ•´ç†å˜å¾—ç®€å•è€Œé«˜æ•ˆ
          </p>

          <!-- å¿«æ·æ“ä½œæŒ‰é’® -->
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
            <RouterLink to="/files" class="btn btn-primary btn-lg gap-3 w-full sm:w-auto">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                ></path>
              </svg>
              ä¸Šä¼ æ–‡ä»¶
            </RouterLink>
            <RouterLink to="/notes" class="btn btn-outline btn-lg gap-3 w-full sm:w-auto">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                ></path>
              </svg>
              æ–°å»ºç¬”è®°
            </RouterLink>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto px-4 py-8">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">æ€»æ–‡ä»¶æ•°</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100 mt-1">
                {{ stats.totalFiles }}
              </p>
            </div>
            <div
              class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-blue-600 dark:text-blue-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">ç¬”è®°æ•°é‡</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100 mt-1">
                {{ stats.totalNotes }}
              </p>
            </div>
            <div
              class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-green-600 dark:text-green-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">å­˜å‚¨ä½¿ç”¨</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100 mt-1">
                {{ formatSize(stats.totalSize) }}
              </p>
            </div>
            <div
              class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-xl flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-purple-600 dark:text-purple-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">ä»Šæ—¥æ´»åŠ¨</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100 mt-1">
                {{ stats.todayActivity }}
              </p>
            </div>
            <div
              class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-xl flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-orange-600 dark:text-orange-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- æœ€è¿‘æ´»åŠ¨å’ŒåŠŸèƒ½ä»‹ç» -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- æœ€è¿‘æ–‡ä»¶ -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
        >
          <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">æœ€è¿‘æ–‡ä»¶</h2>
              <RouterLink to="/files" class="text-sm text-blue-600 hover:text-blue-500 font-medium">
                æŸ¥çœ‹å…¨éƒ¨ â†’
              </RouterLink>
            </div>
          </div>
          <div class="p-6">
            <div v-if="recentFiles.length === 0" class="text-center py-8">
              <div class="text-4xl mb-4">ğŸ“‚</div>
              <p class="text-gray-500 dark:text-gray-400">è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶</p>
              <RouterLink to="/files" class="btn btn-sm btn-primary mt-4">
                ä¸Šä¼ ç¬¬ä¸€ä¸ªæ–‡ä»¶
              </RouterLink>
            </div>
            <div v-else class="space-y-3">
              <div
                v-for="file in recentFiles"
                :key="file.id"
                class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer"
                @click="goToFiles"
              >
                <div
                  :class="`w-10 h-10 rounded-lg flex items-center justify-center text-sm ${getFileTypeColor(file.mime_type)}`"
                >
                  {{ getFileIcon(file.mime_type) }}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-medium text-gray-900 dark:text-gray-100 truncate">
                    {{ file.filename }}
                  </p>
                  <p class="text-xs text-gray-500">{{ formatDate(file.created_at) }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœ€è¿‘ç¬”è®° -->
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
        >
          <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">æœ€è¿‘ç¬”è®°</h2>
              <RouterLink to="/notes" class="text-sm text-blue-600 hover:text-blue-500 font-medium">
                æŸ¥çœ‹å…¨éƒ¨ â†’
              </RouterLink>
            </div>
          </div>
          <div class="p-6">
            <div v-if="recentNotes.length === 0" class="text-center py-8">
              <div class="text-4xl mb-4">ğŸ“</div>
              <p class="text-gray-500 dark:text-gray-400">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç¬”è®°</p>
              <RouterLink to="/notes" class="btn btn-sm btn-primary mt-4">
                åˆ›å»ºç¬¬ä¸€ä¸ªç¬”è®°
              </RouterLink>
            </div>
            <div v-else class="space-y-3">
              <div
                v-for="note in recentNotes"
                :key="note.id"
                class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer"
                @click="goToNotes"
              >
                <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-1 truncate">
                  {{ note.title || 'æ— æ ‡é¢˜' }}
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-2 line-clamp-2">
                  {{ note.content }}
                </p>
                <p class="text-xs text-gray-500">{{ formatDate(note.updated_at) }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
      <div class="mt-12">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">å¼ºå¤§çš„åŠŸèƒ½ç‰¹ç‚¹</h2>
          <p class="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
            ArchiveNote æä¾›å®Œæ•´çš„æ–‡ä»¶å’Œç¬”è®°ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œè®©æ‚¨çš„å·¥ä½œæ›´æœ‰æ¡ç†
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <div class="text-center p-6">
            <div
              class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-2xl flex items-center justify-center mx-auto mb-4"
            >
              <svg
                class="w-8 h-8 text-blue-600 dark:text-blue-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                ></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">å¤šæ ¼å¼æ”¯æŒ</h3>
            <p class="text-gray-600 dark:text-gray-400">
              æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€PDFã€éŸ³é¢‘ç­‰å¤šç§æ–‡ä»¶æ ¼å¼çš„é¢„è§ˆå’Œç®¡ç†
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-2xl flex items-center justify-center mx-auto mb-4"
            >
              <svg
                class="w-8 h-8 text-green-600 dark:text-green-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">æ™ºèƒ½ç¬”è®°</h3>
            <p class="text-gray-600 dark:text-gray-400">
              ä¸ºæ–‡ä»¶æ·»åŠ ç¬”è®°ï¼Œæ”¯æŒæ–‡ä»¶å…³è”ï¼Œè®©ä¿¡æ¯ç®¡ç†æ›´æœ‰æ¡ç†
            </p>
          </div>

          <div class="text-center p-6">
            <div
              class="w-16 h-16 bg-purple-100 dark:bg-purple-900 rounded-2xl flex items-center justify-center mx-auto mb-4"
            >
              <svg
                class="w-8 h-8 text-purple-600 dark:text-purple-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">å¿«é€Ÿæœç´¢</h3>
            <p class="text-gray-600 dark:text-gray-400">
              å¼ºå¤§çš„æœç´¢åŠŸèƒ½ï¼Œå¿«é€Ÿæ‰¾åˆ°æ‚¨éœ€è¦çš„æ–‡ä»¶å’Œç¬”è®°
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { RouterLink, useRouter } from 'vue-router'
import fileService from '../../api/fileService.js'
import noteService from '../../api/noteService.js'
import statsService from '../../api/statsService.js'
import { formatSize } from '@/utils/format'
import { getFileIcon, getFileTypeColor } from '@/utils/file'

const router = useRouter()

const stats = ref({
  totalFiles: 0,
  totalNotes: 0,
  totalSize: 0,
  todayActivity: 0,
})

const recentFiles = ref([])
const recentNotes = ref([])

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateString) => {
  const date = new Date(dateString)
  const now = new Date()
  const diff = now - date
  const days = Math.floor(diff / (1000 * 60 * 60 * 24))

  if (days === 0) return 'ä»Šå¤©'
  if (days === 1) return 'æ˜¨å¤©'
  if (days < 7) return `${days}å¤©å‰`
  return date.toLocaleDateString()
}

// å¯¼èˆªåˆ°é¡µé¢
const goToFiles = () => router.push('/files')
const goToNotes = () => router.push('/notes')

// åŠ è½½æ•°æ®
const loadData = async () => {
  try {
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    const statsData = await statsService.getStats()
    stats.value.totalFiles = statsData.file_count
    stats.value.totalSize = statsData.storage_usage
    stats.value.totalNotes = statsData.note_count
    stats.value.todayActivity = statsData.today_activity

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨ç”¨äºå±•ç¤ºæœ€è¿‘æ–‡ä»¶
    const filesResponse = await fileService.getFiles()
    const files = filesResponse.data || []

    // æœ€è¿‘æ–‡ä»¶ï¼ˆæœ€å¤š5ä¸ªï¼‰
    recentFiles.value = files
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .slice(0, 5)

    // åŠ è½½ç¬”è®°åˆ—è¡¨ç”¨äºå±•ç¤ºæœ€è¿‘ç¬”è®°
    const notesResponse = await noteService.getNotes()
    const notes = notesResponse.data || []

    // æœ€è¿‘ç¬”è®°ï¼ˆæœ€å¤š5ä¸ªï¼‰
    recentNotes.value = notes
      .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
      .slice(0, 5)

  } catch (error) {
    console.error('Failed to load dashboard data', error)
  }
}

onMounted(() => {
  loadData()
})
</script>
